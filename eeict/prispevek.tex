%--------------------------------------------------------------------------------
%
% Text pøíspìvku do sborníku EEICT
%
% Vytvoøil:  Martin Drahanskı
% Datum:     26.02.2007
% E-mail:    drahan@fit.vutbr.cz
%
%--------------------------------------------------------------------------------
%
% Pøeloení: pdflatex prispevek.tex
%
% Optimální zpùsob pouití = pøepište jen vlastní text
%
\documentclass{eeict}
\inputencoding{cp1250}
\usepackage[bf]{caption2}
\usepackage{hyperref}
%--------------------------------------------------------------------------------

\title{FILESYSTEM CONSISTENCY CHECK FOR UNIVERSAL DISK FORMAT}
\author{Vojtìch Vladyka}
\programme{Master Degree Programme (2), FEEC BUT}
\emails{xvlady00@stud.feec.vutbr.cz}

\supervisor{Petr Petyovskı}
\emailv{petyovsky@feec.vutbr.cz}

\abstract{This paper focus on creation of tool for detection and correction for UDF filesystem in OS Linux. It describes all available error detection machanisms described by ECMA-167 standard and possible solution how to correct them.}
\keywords{UDF, fsck, Linux, error detection, error correction}

\begin{document}
% -- Hlavièka práce --

\maketitle

%-------------------------------------------------------------------------------
\selectlanguage{czech}
\section{Úvod}
V poèítaèové technice jsou data to, co má nìjakou hodnotu. Proto je nutné klást dùraz na detekci pøípadnıch chyb na souborovém systému a monosti jejich korekce. Pøi této monosti nelze povaovat úloné øešení za pouitelné. 

Právì z tohoto dùvodu byla zapoèata práce na nástroji udffsck pro OS Linux, protoe v souèasné chvíli tento nástroj neexistuje. Cílem tohoto nástroje je detekovat a opravovat chyby na souborovém systému Universal Disk Format (UDF). 

\section{Filesystem Consistency Check}
Filesystem Consistency Check (fsck, \cite{man-fsck}) je Unixovı nástroj urèenı pro kontrolu a opravu souborovıch systémù. Tento nástroj ovšem pouze zapouzdøuje nástroje specializované pro danı soborovı systém, kterı má bıt kontrolován a poskytuje tak uivateli univerzální ovládací rozhraní. Problém pøed kterım stála tato práce byl právì v absenci nástroje fsck pro souborovı systém UDF (více dále v textu), protoe právì absence nástroje na kontrolu souborového systému je zásadním omezením pouitelnosti daného souborového systému.

Nástroj fsck je mnou aktuálnì rozpracován v linuxovém balíèku udftools \cite{udftools-github, udftools-github-fork}, kterı je zaøazen ve vìtšinì dominantních linuxovıch distribucí. Cílem práce je po jeho dokonèení zaøazení do hlavního repozitáøe balíèku udftools.

\section{Universal Disk Format}
Universal Disk Format (UDF) je souborovı systém, kterı vznikl jako následovník souborového systému ISO~9660, vyvinutého pro CD. UDF bìhem svého vıvoje prodìlalo øadu rozšíøení aby odpovídalo na poadavky médií, pro které bylo pøednostnì urèeno. Takto se postupnì rozšíøilo od CD na DVD a BD. Ovšem díky svému zamìøení na univerzálnost a pøesnositelnost je i v této dobì úpadku optickıch médií optimální volbou pro pøenos dat mezi rùznımi operaèními systémy napøíklad na flash discích.

UDF je popsané pøednostnì dokumentem Universal Disk Format Specification \cite{osta-udf-0201} a také standardem ECMA-167 \cite{ecma-167}. Vzhledem k faktu, e balíèek udftools podporuje UDF do verze 2.01 (rozšíøení pro DVD-RW) tak i moje implementace míøí k této verzi pøestoe nejaktuálnìjší verze je 2.60 (rozšíøení pro Blu-Ray.) Po aktualizaci zbytku balíèku nebude problém povıšit i nástroj udffsck.

\section{Detekce chyb a jejich oprava}
\label{sec:errors}
Detekce chyb je jádrem celé práce. UDF nám díky svému návrhu nabízí nìkolik detekèních mechanismù. Jedná se o tyto:
\begin{itemize}
    \item Kontrolní souèet (Checksum)
    \item Cyclic Redundancy Check (CRC)
    \item Redundance deskriptorù souborového systému
    \item Zápisovı byte
\end{itemize}

\textbf{Kontrolní souèet (Checksum)} zajišuje kontrolní mechansimus všech identifikátorù (tagù) deskriptorù souborového systému. Jedná se o prostı souèet hodnot všech bytù tagu vyjma místa pro vısledek samotnı a následné modulo 256 (t.j. oøez vısledku na délku spodních 8~bitù.)

\textbf{Cyclic Redundancy Check (CRC)} zajišuje kontrolu samotnıch deskriptorù, pøièem referenèní hodnota je uloena v tagu deskriptoru a tudí zajištìná checksumem. Pouívá se CRC-CCIT, které je definováno tìmito parametry:
\begin{itemize}
    \item Délka: 16~bit
    \item Vstupní polynom: \texttt{0x1021}
    \item Vıchozí hodnota: \texttt{0xFFFF}
    \item Vstupní data nejsou zrcadlena (t.j. není provedena bitová rotace nad bytem)
    \item Vıstupní CRC není zrcadleno
    \item Nad vıstupním CRC není provedena operace XOR
\end{itemize}

\textbf{Redundance deskriptorù} je pouita u skupiny deskriptorù s názvem Volume Descriptor Sequence (VDS). Ta obsahuje všechna metadata tıkající se souborového systému jako takového, nikoliv dat. VDS je uloeno ve dvou exempláøích jako Main VDS a Reserve VDS. Další pøípad redundance je v pøípadì Anchor Volume Descriptor Sequence (AVDP) co je vıchozí bod pro naètení souborového systému. Ten je uloen alespoò ve dvou exempláøích, èasto však ve tøech. 

\textbf{Zápisovı byte} je mechansimus tıkající se konzistence dat. Povinností ovladaèe souborového systému je v pøípadì zahájení zápisové operace nastavit byte v deskriptoru \textit{Logical Volume Integrity Descriptor} (\cite[s.~62-63]{ecma-167}) jako \textit{Open Integrity Descriptor} a vrátit ho do stavu \textit{Closed Integrity Descriptor} a po ukonèení zápisové operace nebo odpojení oddílu. Tímto je zajištìno, e v pøípadì pøerušení zápisové operace bude oddíl oznaèen jako nekonzistentní a mùe s ním bıt podle toho nakládáno. 

Z tohoto vıètu je evidentní, e je moné detekovat chyby v jakémkoli deskriptoru, pøípadnì detekovat nedokonèenı zápis dat, ale snadná korekce je moná pouze u VDS a AVDP. Korekce poškození samotnıch dat je nemoná kvùli absenci mechanismu na detekci chyby.

\section{Návrh nástroje udffsck}
Nástroj udffsck je koncipován jako interaktivní nástroj s moností automatické korekce. Funkce nástroje je rozdìlena do dvou fází:
\begin{enumerate}
    \item Detekce chyb popsanıch v kapitole \ref{sec:errors} a jejich nahlášení uivateli - podle míry poškození buï dojde a ke kontrole souborového stromu nebo detekce skonèí v nìkteré z pøedchzejících fází. Typické body kde mùe detekce uvíznout je znièení všech AVDP (obsahuje ukazatel na VDS), znièení obou LVD (\textit{Logical Volume Descriptor}, obsahuje ukazatel na koøenovı adresáø) nebo znièení \textit{File Entry} koøenového adresáøe, pøípadnì nìkterého z podadresáøù. Pokraèování v kontrole poté nneí ji moné, protoe se nelze øídit daty v poškozenıch deskriptorech. 
        
Je na zváení pøidání monosti pouití takovıch deskriptorù i pøes jejich poškození, protoe tato monost mùe umonit alespoò obnovu èásti dat v pøípadì katastrofického poškození.

    \item Korekce chyb kde je to moné a zápis opravené verze. Pokud detekce prošla a k souborovému stromu, je moné provést i korekci v deskriptorech dat v pøípadì nìjakıch nedokonèenıch zápisù. 
\end{enumerate}

Návrh poèítá s zaèlenìním udffsck mezi ostatní fsck, take dodruje standardizované návratové hodnoty. Vstupní parametry standardizovány nejsou.

\section{Závìr}
Byla nastínìna problematika detekce chyb na souborovém systému UDF a monosti jejich korekce. Bylo nastínìno nìkolik variant jak lze provést jejich korekci vèetnì pøípadnıch moností pro obnovu pøi velkém poškoení.     

V dobì psaní této práce je projekt rozpracovanı a umoòuje provést detekci všech chyb vyjma neukonèené zápisové operace a koreci poškozeného AVDP a VRS.

Od zapoèetí práce jsem v kontaktu se souèasnım správcem balíèku udftools i s tvùrci rùznıch nástrojù pro korekci UDF pro FreeBSD. Stejnì tak byla snaha o zkontaktování autorù nástroje udf\_fsck v OS X ale nebyla vyslyšena. Podobnì dopadla i snaha o kontakt s tvùrci nástroje udfct od spoleènosti Philips, kterı provádí kontrolu média vùèi standardu. 

%------------
% Citace
%
\begin{thebibliography}{9}
    
    \bibitem{man-fsck}
            Fsck. \emph{Die.net} [online]. [cit. 2017-01-02]. Dostupné z: \url{https://linux.die.net/man/8/fsck}
    
    \bibitem{udftools-github}
            \emph{pali/udftools. In: GitHub}\/ [online]. 2016 [cit. 2016-11-21]. Dostupné z: \url{https://github.com/pali/udftools}
    
    \bibitem{udftools-github-fork}
            \emph{argorain/udftools. In: GitHub}\/ [online]. 2017 [cit. 2017-03-08]. Dostupné z: \url{https://github.com/argorain/udftools}
    
    \bibitem{osta-udf-0201}
            \emph{Universal Disk Format Specification}. Revision 2.01. Cupertino, California: Optical Storage Technology Association, 2000.

    \bibitem{ecma-167}
        \emph{ECMA-167}. 3rd Edition. Geneva, Switzerland: ECMA, 1997.
    

\end{thebibliography}

\end{document}
